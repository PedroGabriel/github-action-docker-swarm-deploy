name: 'docker-swarm-deploy-github-action'
description: 'Deploy your Docker Swarm apps in seconds. ðŸš€'
inputs:
  deployment_ssh_private_key:
    description: 'The private key you have authenticated to connect to your server via SSH.'
    required: true
  remote_ssh_known_host:
    description: 'The public key of your SSH server to validate we are connecting to the right server.'
    required: true
  remote_ssh_deployment_user:
    description: 'The user that you would like to connect as on the remote server via SSH.'
    required: true
  remote_ssh_server:
    description: 'The hostname or IP address of the server you want to connect to.'
    required: true
  remote_ssh_port:
    description: 'The SSH port of the remote server you would like to connect to.'
    default: '22'
    required: false
  project_name:
    description: 'The name of the project you would like to use.'
    default: 'swarm-app'
    required: false
runs:
  using: 'composite'
  steps:

      ##
      ## Run ssh-agent (inside the build environment)
      ##
      - name: Configure SSH environment
        run: eval $(ssh-agent -s)
        shell: bash

      ##
      ## Add the SSH key stored in DEPLOYMENT_SSH_PRIVATE_KEY variable to the agent store
      ## We're using tr to fix line endings which makes ed25519 keys work
      ## without extra base64 encoding.
      ## https://gitlab.com/gitlab-examples/ssh-private-key/issues/1#note_48526556
      ##
      - name: Add SSH key to environment
        run: echo "${{ inputs.deployment_ssh_private_key }}" | tr -d '\r' | ssh-add -
        shell: bash

      ##
      ## Create the SSH directory and give it the right permissions
      ##
      - name: Prepare SSH configuration
        run: | 
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
        shell: bash

      ##
      ## Add the known host value for the remote machine (prevent MITM attacks)
      ##
      - name: Configure known host for the remote machine
        run: | 
          echo "${{ inputs.remote_ssh_known_host }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
        shell: bash

      ##
      ## Store the time for any priority usage.
      ##
      - name: Set the current time to the "NOW" variable
        run: NOW=$(date +%s)
        shell: bash

      ##
      ## Run the deployment
      ##
      - name: Run the Docker Swarm deployment
        run: |
          docker -H \
            ssh://${{ inputs.remote_ssh_deployment_user }}@${{ inputs.remote_ssh_server }}:${{ inputs.remote_ssh_port }} \
            stack deploy --with-registry-auth \
            --compose-file docker-compose.yml -c docker-compose.prod.yml \
            ${{ inputs.project_name }} --prune
        shell: bash

branding:
  icon: 'zap'
  color: 'blue'
